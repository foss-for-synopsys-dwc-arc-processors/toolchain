<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Building Linux Image for Working with eBPF in QEMU &mdash; GNU Toolchain for ARC User Manual 2022.09 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/style_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Building Clang with eBPF Target for ARC HS Hosts" href="clang.html" />
    <link rel="prev" title="Cross-compiling eBPF Programs" href="cross.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> GNU Toolchain for ARC User Manual
          </a>
              <div class="version">
                2022.09
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../baremetal/index.html">Building baremetal applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../baremetal/index.html#debugging-baremetal-applications">Debugging baremetal applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/index.html">Linux applications</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">eBPF</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="cross.html">Cross-compiling eBPF Programs</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Building Linux Image for Working with eBPF in QEMU</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#preparing-linux-host">Preparing Linux Host</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#notes-for-centos-7">Notes for CentOS 7</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#preparing-tools-and-libraries">Preparing Tools and Libraries</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#building-and-installing-elfutils">Building and Installing <code class="docutils literal notranslate"><span class="pre">elfutils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-and-installing-pahole">Building and Installing <code class="docutils literal notranslate"><span class="pre">pahole</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-and-installing-bpftool">Building and Installing <code class="docutils literal notranslate"><span class="pre">bpftool</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#preparing-building-environment">Preparing Building Environment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cloning-arc-ebpf-testbench">Cloning ARC eBPF Testbench</a></li>
<li class="toctree-l4"><a class="reference internal" href="#preparing-buildroot">Preparing Buildroot</a></li>
<li class="toctree-l4"><a class="reference internal" href="#preparing-linux-sources">Preparing Linux Sources</a></li>
<li class="toctree-l4"><a class="reference internal" href="#installing-ssh-keys-for-user-s-authentication">Installing SSH Keys for User’s Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="#install-ssh-keys-for-host-s-authentication-host-keys">Install SSH Keys for Host’s Authentication (Host Keys)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#building-images">Building Images</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#building-rootfs-cpio">Building <code class="docutils literal notranslate"><span class="pre">rootfs.cpio</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-vmlinux">Building <code class="docutils literal notranslate"><span class="pre">vmlinux</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#workarounds-for-well-known-pitfalls">Workarounds for Well Known Pitfalls</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#errors-while-building-kernel-s-ebpf-files">Errors While Building Kernel’s eBPF Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#workaround-for-complex-float-error">Workaround for <code class="docutils literal notranslate"><span class="pre">complex</span> <span class="pre">float</span></code> error</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#running-linux-image-using-qemu">Running Linux Image Using QEMU</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#running-linux-using-user-level-network-interface">Running Linux Using User Level Network Interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-linux-using-tun-tap-network-interface">Running Linux Using TUN/TAP Network Interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuring-linux">Configuring Linux</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-kernel-s-basic-ebpf-tests">Running Kernel’s Basic eBPF Tests</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#building-and-running-ebpf-programs">Building and Running eBPF Programs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-nfs-for-building-ebpf-programs-right-on-the-target">Using NFS for Building eBPF Programs Right on the Target</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configuring-nfs-in-centos-7-or-fedora">Configuring NFS in CentOS 7 or Fedora</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuring-nfs-in-ubuntu-18-04">Configuring NFS in Ubuntu 18.04</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuring-etc-exports">Configuring <code class="docutils literal notranslate"><span class="pre">/etc/exports</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#mounting-nfs-directory-inside-the-guest">Mounting NFS Directory Inside the Guest</a></li>
<li class="toctree-l4"><a class="reference internal" href="#preparing-tools">Preparing Tools</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-ebpf-application">Building eBPF Application</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="clang.html">Building Clang with eBPF Target for ARC HS Hosts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../other/index.html">Other</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">ARC GNU IDE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gcc/index.html">GCC documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Information for Toolchain maintainers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../man-pages.html">GNU man pages</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">GNU Toolchain for ARC User Manual</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">eBPF</a></li>
      <li class="breadcrumb-item active">Building Linux Image for Working with eBPF in QEMU</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/ebpf/env.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="building-linux-image-for-working-with-ebpf-in-qemu">
<h1>Building Linux Image for Working with eBPF in QEMU<a class="headerlink" href="#building-linux-image-for-working-with-ebpf-in-qemu" title="Permalink to this heading"></a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id1">Overview</a></p></li>
<li><p><a class="reference internal" href="#preparing-linux-host" id="id2">Preparing Linux Host</a></p>
<ul>
<li><p><a class="reference internal" href="#notes-for-centos-7" id="id3">Notes for CentOS 7</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#preparing-tools-and-libraries" id="id4">Preparing Tools and Libraries</a></p>
<ul>
<li><p><a class="reference internal" href="#building-and-installing-elfutils" id="id5">Building and Installing <code class="docutils literal notranslate"><span class="pre">elfutils</span></code></a></p></li>
<li><p><a class="reference internal" href="#building-and-installing-pahole" id="id6">Building and Installing <code class="docutils literal notranslate"><span class="pre">pahole</span></code></a></p></li>
<li><p><a class="reference internal" href="#building-and-installing-bpftool" id="id7">Building and Installing <code class="docutils literal notranslate"><span class="pre">bpftool</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#preparing-building-environment" id="id8">Preparing Building Environment</a></p>
<ul>
<li><p><a class="reference internal" href="#cloning-arc-ebpf-testbench" id="id9">Cloning ARC eBPF Testbench</a></p></li>
<li><p><a class="reference internal" href="#preparing-buildroot" id="id10">Preparing Buildroot</a></p></li>
<li><p><a class="reference internal" href="#preparing-linux-sources" id="id11">Preparing Linux Sources</a></p></li>
<li><p><a class="reference internal" href="#installing-ssh-keys-for-user-s-authentication" id="id12">Installing SSH Keys for User’s Authentication</a></p></li>
<li><p><a class="reference internal" href="#install-ssh-keys-for-host-s-authentication-host-keys" id="id13">Install SSH Keys for Host’s Authentication (Host Keys)</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#building-images" id="id14">Building Images</a></p>
<ul>
<li><p><a class="reference internal" href="#building-rootfs-cpio" id="id15">Building <code class="docutils literal notranslate"><span class="pre">rootfs.cpio</span></code></a></p></li>
<li><p><a class="reference internal" href="#building-vmlinux" id="id16">Building <code class="docutils literal notranslate"><span class="pre">vmlinux</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#workarounds-for-well-known-pitfalls" id="id17">Workarounds for Well Known Pitfalls</a></p>
<ul>
<li><p><a class="reference internal" href="#errors-while-building-kernel-s-ebpf-files" id="id18">Errors While Building Kernel’s eBPF Files</a></p></li>
<li><p><a class="reference internal" href="#workaround-for-complex-float-error" id="id19">Workaround for <code class="docutils literal notranslate"><span class="pre">complex</span> <span class="pre">float</span></code> error</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#running-linux-image-using-qemu" id="id20">Running Linux Image Using QEMU</a></p>
<ul>
<li><p><a class="reference internal" href="#running-linux-using-user-level-network-interface" id="id21">Running Linux Using User Level Network Interface</a></p></li>
<li><p><a class="reference internal" href="#running-linux-using-tun-tap-network-interface" id="id22">Running Linux Using TUN/TAP Network Interface</a></p></li>
<li><p><a class="reference internal" href="#configuring-linux" id="id23">Configuring Linux</a></p></li>
<li><p><a class="reference internal" href="#running-kernel-s-basic-ebpf-tests" id="id24">Running Kernel’s Basic eBPF Tests</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#building-and-running-ebpf-programs" id="id25">Building and Running eBPF Programs</a></p></li>
<li><p><a class="reference internal" href="#using-nfs-for-building-ebpf-programs-right-on-the-target" id="id26">Using NFS for Building eBPF Programs Right on the Target</a></p>
<ul>
<li><p><a class="reference internal" href="#configuring-nfs-in-centos-7-or-fedora" id="id27">Configuring NFS in CentOS 7 or Fedora</a></p></li>
<li><p><a class="reference internal" href="#configuring-nfs-in-ubuntu-18-04" id="id28">Configuring NFS in Ubuntu 18.04</a></p></li>
<li><p><a class="reference internal" href="#configuring-etc-exports" id="id29">Configuring <code class="docutils literal notranslate"><span class="pre">/etc/exports</span></code></a></p></li>
<li><p><a class="reference internal" href="#mounting-nfs-directory-inside-the-guest" id="id30">Mounting NFS Directory Inside the Guest</a></p></li>
<li><p><a class="reference internal" href="#preparing-tools" id="id31">Preparing Tools</a></p></li>
<li><p><a class="reference internal" href="#building-ebpf-application" id="id32">Building eBPF Application</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="overview">
<h2><a class="toc-backref" href="#id1">Overview</a><a class="headerlink" href="#overview" title="Permalink to this heading"></a></h2>
<p>This is a comprehensive guide about creating an environment for
building, running and debugging eBPF programs for ARC processors using
<a class="reference external" href="https://github.com/foss-for-synopsys-dwc-arc-processors/arc-gnu-toolchain">GNU toolchain</a>
and <a class="reference external" href="https://github.com/foss-for-synopsys-dwc-arc-processors/qemu">QEMU</a>. Though we consider
ARC HS 3x/4x on QEMU as a reference platform, the same guide is applicable for boards
like HS Development Kit.</p>
<p>This guide consists of these steps:</p>
<ol class="arabic simple">
<li><p>Preparing your Linux host for building <code class="docutils literal notranslate"><span class="pre">rootfs</span></code> (Buildroot), Linux kernel, third-party tools and libraries.</p></li>
<li><p>Building and installing third-party tools and libraries: <code class="docutils literal notranslate"><span class="pre">elfutils</span></code>, <code class="docutils literal notranslate"><span class="pre">pahole</span></code> and <code class="docutils literal notranslate"><span class="pre">bpftool</span></code>. We are going to build them manually to ensure that the latest versions are used.</p></li>
<li><p>Preparing the building environment: cloning all necessary repositories, configuring SSH keys, etc.</p></li>
<li><p>Building <code class="docutils literal notranslate"><span class="pre">rootfs</span></code> (Buildroot) image and the Linux kernel.</p></li>
<li><p>Building and running eBPF programs.</p></li>
</ol>
</section>
<section id="preparing-linux-host">
<h2><a class="toc-backref" href="#id2">Preparing Linux Host</a><a class="headerlink" href="#preparing-linux-host" title="Permalink to this heading"></a></h2>
<p>We assume that toolchain directory for ARC HS 3x/4x is placed in <code class="docutils literal notranslate"><span class="pre">/tools/arc-linux-gnu</span></code>
(the directory which contains <code class="docutils literal notranslate"><span class="pre">bin</span></code>). Ensure that <code class="docutils literal notranslate"><span class="pre">/tools/arc-linux-gnu/bin</span></code> is in
<code class="docutils literal notranslate"><span class="pre">PATH</span></code> environment variable. We are going to use <code class="docutils literal notranslate"><span class="pre">/tools</span></code> directory for installing
tools and libraries. You can use any other path, just don’t forget to consider it while
reading this guide.</p>
<p>The latest release may be downloaded here (“Linux/glibc ARC HS” variant):</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/foss-for-synopsys-dwc-arc-processors/toolchain/releases">https://github.com/foss-for-synopsys-dwc-arc-processors/toolchain/releases</a></p></li>
</ul>
<p>Standard development tools must be installed on your host: <code class="docutils literal notranslate"><span class="pre">make</span></code>, <code class="docutils literal notranslate"><span class="pre">cmake</span></code>, <code class="docutils literal notranslate"><span class="pre">git</span></code>, <code class="docutils literal notranslate"><span class="pre">rsync</span></code>,
<code class="docutils literal notranslate"><span class="pre">gcc</span></code>, <code class="docutils literal notranslate"><span class="pre">binutils</span></code>, <code class="docutils literal notranslate"><span class="pre">clang</span></code> (for building eBPF programs).</p>
<section id="notes-for-centos-7">
<h3><a class="toc-backref" href="#id3">Notes for CentOS 7</a><a class="headerlink" href="#notes-for-centos-7" title="Permalink to this heading"></a></h3>
<p>It’s necessary to install the latest available development tools for CentOS 7
to make it possible to build everything without problems. Use <code class="docutils literal notranslate"><span class="pre">centos-release-scl</span></code>
repository to install the latest tools and Git. Then, have them enabled.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>centos-release-scl
sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>devtoolset-9<span class="w"> </span>rh-git227
scl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>devtoolset-9<span class="w"> </span>rh-git227<span class="w"> </span>bash
</pre></div>
</div>
</section>
</section>
<section id="preparing-tools-and-libraries">
<h2><a class="toc-backref" href="#id4">Preparing Tools and Libraries</a><a class="headerlink" href="#preparing-tools-and-libraries" title="Permalink to this heading"></a></h2>
<p>We are going to build and install some tools an libraries manually:</p>
<p>1. <code class="docutils literal notranslate"><span class="pre">pahole</span></code> host tool is used during the generation of BTF information for the Linux image.
We have to use version ≤1.23 because later versions generate BTF information for 64-bit
enumerations. However, the Linux kernel of version ≤6.0 contains tools which don’t
support such BTF records and building fails on the last stage. We need to ensure that a proper
<code class="docutils literal notranslate"><span class="pre">pahole</span></code> is used.</p>
<p>2. <code class="docutils literal notranslate"><span class="pre">elfutils</span></code> host libraries of version ≥0.189 must be presented in <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> because
<code class="docutils literal notranslate"><span class="pre">pahole</span></code> relies on them for working with binaries. Support of ARCv2 was added in <code class="docutils literal notranslate"><span class="pre">elfutils</span></code> 0.189,
thus we need to ensure that <code class="docutils literal notranslate"><span class="pre">pahole</span></code> is linked with recent-enough <code class="docutils literal notranslate"><span class="pre">elfutils</span></code> libraries.</p>
<p>3. <code class="docutils literal notranslate"><span class="pre">bpftool</span></code> of version ≥7 must be used for building eBPF program which use features like <code class="docutils literal notranslate"><span class="pre">bpf_loop</span></code>,
calls to another functions, etc. Older versions don’t support new type of relocations for such
features. If you are experiencing problems with host’s <code class="docutils literal notranslate"><span class="pre">bpftool</span></code> (e.g., Ubuntu 22.04 is shipped
with an outdated <code class="docutils literal notranslate"><span class="pre">bpftool</span></code> which may fail while building the kernel) then it would be better to
build and install it manually.</p>
<section id="building-and-installing-elfutils">
<h3><a class="toc-backref" href="#id5">Building and Installing <code class="docutils literal notranslate"><span class="pre">elfutils</span></code></a><a class="headerlink" href="#building-and-installing-elfutils" title="Permalink to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install dependencies for CentOS 7</span>
sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>libmicrohttpd<span class="w"> </span>libmicrohttpd-devel<span class="w"> </span>libsq3<span class="w"> </span>libsq3-devel<span class="w"> </span><span class="se">\</span>
<span class="w">                 </span>libarchive<span class="w"> </span>libarchive-devel<span class="w"> </span>gettext-devel<span class="w"> </span>zstd<span class="w"> </span>libcurl-devel

<span class="c1"># Install dependencies for the latest Fedora</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>libmicrohttpd<span class="w"> </span>libmicrohttpd-devel<span class="w"> </span>libsq3<span class="w"> </span>libsq3-devel<span class="w"> </span><span class="se">\</span>
<span class="w">                 </span>libarchive<span class="w"> </span>libarchive-devel<span class="w"> </span>gettext-devel

<span class="c1"># Install dependencies for Ubuntu 18.04</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>libmicrohttpd-dev<span class="w"> </span>libsqlite3-dev<span class="w"> </span>libarchive-dev

<span class="c1"># Clone, configure and build elfutils (use your own prefix instead of /tools/elfutils)</span>
git<span class="w"> </span>clone<span class="w"> </span>-b<span class="w"> </span>elfutils-0.189<span class="w"> </span>https://sourceware.org/git/elfutils.git
<span class="nb">cd</span><span class="w"> </span>elfutils
autoreconf<span class="w"> </span>-fi
mkdir<span class="w"> </span>build
<span class="nb">cd</span><span class="w"> </span>build
../configure<span class="w"> </span>--prefix<span class="o">=</span>/tools/elfutils<span class="w"> </span>--enable-maintainer-mode
make
make<span class="w"> </span>install

<span class="c1"># Configure your environment</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>/tools/elfutils/bin:<span class="nv">$PATH</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/tools/elfutils/lib<span class="si">${</span><span class="nv">LD_LIBRARY_PATH</span><span class="p">:+:</span><span class="nv">$LD_LIBRARY_PATH</span><span class="si">}</span>
</pre></div>
</div>
</section>
<section id="building-and-installing-pahole">
<h3><a class="toc-backref" href="#id6">Building and Installing <code class="docutils literal notranslate"><span class="pre">pahole</span></code></a><a class="headerlink" href="#building-and-installing-pahole" title="Permalink to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clone, configure and build pahole (use your own prefix instead of /tools/pahole)</span>
git<span class="w"> </span>clone<span class="w"> </span>-b<span class="w"> </span>v1.23<span class="w"> </span>https://git.kernel.org/pub/scm/devel/pahole/pahole.git
mkdir<span class="w"> </span>pahole/build
<span class="nb">cd</span><span class="w"> </span>pahole/build
cmake<span class="w"> </span>-G<span class="w"> </span><span class="s2">&quot;Unix Makefiles&quot;</span><span class="w">                              </span><span class="se">\</span>
<span class="w">      </span>-D__LIB<span class="o">=</span>lib<span class="w">                                      </span><span class="se">\</span>
<span class="w">      </span>-DDWARF_INCLUDE_DIR<span class="o">=</span>/tools/elfutils/include<span class="w">      </span><span class="se">\</span>
<span class="w">      </span>-DLIBDW_INCLUDE_DIR<span class="o">=</span>/tools/elfutils/include<span class="w">      </span><span class="se">\</span>
<span class="w">      </span>-DDWARF_LIBRARY<span class="o">=</span>/tools/elfutils/lib/libdw.so.1<span class="w">   </span><span class="se">\</span>
<span class="w">      </span>-DELF_LIBRARY<span class="o">=</span>/tools/elfutils/lib/libelf.so.1<span class="w">    </span><span class="se">\</span>
<span class="w">      </span>-DCMAKE_INSTALL_PREFIX<span class="o">=</span>/tools/pahole<span class="w">             </span><span class="se">\</span>
<span class="w">      </span>..
make<span class="w"> </span>install

<span class="c1"># Configure your environment</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>/tools/pahole/bin:<span class="nv">$PATH</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/tools/pahole/lib<span class="si">${</span><span class="nv">LD_LIBRARY_PATH</span><span class="p">:+:</span><span class="nv">$LD_LIBRARY_PATH</span><span class="si">}</span>
</pre></div>
</div>
</section>
<section id="building-and-installing-bpftool">
<h3><a class="toc-backref" href="#id7">Building and Installing <code class="docutils literal notranslate"><span class="pre">bpftool</span></code></a><a class="headerlink" href="#building-and-installing-bpftool" title="Permalink to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clone and build bpftool (use your own prefix instead of /tools/bpftool)</span>
git<span class="w"> </span>clone<span class="w"> </span>--recurse-submodules<span class="w"> </span>https://github.com/libbpf/bpftool.git
<span class="nb">cd</span><span class="w"> </span>bpftool/src
make<span class="w"> </span><span class="nv">prefix</span><span class="o">=</span>/tools/bpftool<span class="w"> </span><span class="nv">EXTRA_CFLAGS</span><span class="o">=</span><span class="s2">&quot;-I/tools/elfutils/include&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                           </span><span class="nv">EXTRA_LDFLAGS</span><span class="o">=</span><span class="s2">&quot;-L/tools/elfutils/lib&quot;</span><span class="w">    </span><span class="se">\</span>
<span class="w">                           </span>install-bin

<span class="c1"># Configure your environment</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>/tools/bpftool/sbin/:<span class="nv">$PATH</span>
</pre></div>
</div>
</section>
</section>
<section id="preparing-building-environment">
<h2><a class="toc-backref" href="#id8">Preparing Building Environment</a><a class="headerlink" href="#preparing-building-environment" title="Permalink to this heading"></a></h2>
<section id="cloning-arc-ebpf-testbench">
<h3><a class="toc-backref" href="#id9">Cloning ARC eBPF Testbench</a><a class="headerlink" href="#cloning-arc-ebpf-testbench" title="Permalink to this heading"></a></h3>
<p>Clone ARC eBPF testbench. This repository contains configuration files for Buildroot and Linux kernel
which simplify setup of the environment for working with eBPF. We are going to use it as a working
directory.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>--recurse-submodules<span class="w"> </span>https://github.com/foss-for-synopsys-dwc-arc-processors/arc-bpf-testbench
<span class="nb">cd</span><span class="w"> </span>arc-bpf-testbench
</pre></div>
</div>
</section>
<section id="preparing-buildroot">
<h3><a class="toc-backref" href="#id10">Preparing Buildroot</a><a class="headerlink" href="#preparing-buildroot" title="Permalink to this heading"></a></h3>
<p>Clone Buildroot, create a build directory and copy all necessary configuration files and an overlay to the
build directory from <code class="docutils literal notranslate"><span class="pre">arc-bpf-testbench/extras</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://git.buildroot.net/buildroot
mkdir<span class="w"> </span>buildroot/build
cp<span class="w"> </span>-r<span class="w"> </span>extras/buildroot/*<span class="w"> </span>buildroot/build
</pre></div>
</div>
<p>List of copied files and directories:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">busybox.fragment</span></code> - A configuration file for BusyBox.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">device_table.txt</span></code> - A configuration file fo setting proper permissions for files in the overlay.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">qemu_hs4x_ebpf_defconfig</span></code> - A configuration file for Buildroot.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">overlay</span></code> - All necessary additional files for target’s file system (configuration files, testing SSH keys, etc.).</p></li>
</ol>
<p>It’s assumed here that the root directory for the toolchain is <code class="docutils literal notranslate"><span class="pre">/tools/arc-linux-gnu</span></code>.
Thus you need to change <code class="docutils literal notranslate"><span class="pre">BR2_TOOLCHAIN_EXTERNAL_PATH</span></code> in <code class="docutils literal notranslate"><span class="pre">qemu_hs4x_ebpf_defconfig</span></code>
configuration file for Buildroot to the corresponding path.</p>
</section>
<section id="preparing-linux-sources">
<h3><a class="toc-backref" href="#id11">Preparing Linux Sources</a><a class="headerlink" href="#preparing-linux-sources" title="Permalink to this heading"></a></h3>
<p>Clone repository of the Linux kernel with the latest patches for support of eBPF with JIT and
copy a corresponding configuration file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>-b<span class="w"> </span>bpf-early-access<span class="w"> </span>https://github.com/foss-for-synopsys-dwc-arc-processors/linux
mkdir<span class="w"> </span>linux/build
cp<span class="w"> </span>extras/linux/qemu_hs4x_ebpf_defconfig<span class="w"> </span>linux/arch/arc/configs
</pre></div>
</div>
</section>
<section id="installing-ssh-keys-for-user-s-authentication">
<h3><a class="toc-backref" href="#id12">Installing SSH Keys for User’s Authentication</a><a class="headerlink" href="#installing-ssh-keys-for-user-s-authentication" title="Permalink to this heading"></a></h3>
<p>We are going to use SSH for interacting with the ARC Linux system. It would be
helpful to have keys for public key authorization without using a password.</p>
<p>You can copy the pregenerated keys from <code class="docutils literal notranslate"><span class="pre">extras/host/.ssh/keys</span></code> to
the corresponding host’s directory <code class="docutils literal notranslate"><span class="pre">~/.ssh/keys</span></code>. Public key for this pair
of keys is already installed in the <code class="docutils literal notranslate"><span class="pre">buildroot/build/overlay/root/.ssh</span></code> directory.
Don’t forget to apply proper rights for those keys in <code class="docutils literal notranslate"><span class="pre">.ssh</span></code> for your host (600).</p>
<p>Configure your SSH hosts in <code class="docutils literal notranslate"><span class="pre">~/.ssh/config</span></code> (you also can find this file
in <code class="docutils literal notranslate"><span class="pre">extras/host/.ssh/config</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Host</span> <span class="n">arc</span>
    <span class="n">HostName</span>            <span class="mf">127.0.0.1</span>
    <span class="n">Port</span>                <span class="mi">2022</span>
    <span class="n">User</span>                <span class="n">root</span>
    <span class="n">IdentityFile</span>        <span class="o">~/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">keys</span><span class="o">/</span><span class="n">arc</span>

<span class="n">Host</span> <span class="n">arc</span><span class="o">-</span><span class="n">tap</span>
    <span class="n">HostName</span>            <span class="mf">10.42.0.100</span>
    <span class="n">Port</span>                <span class="mi">22</span>
    <span class="n">User</span>                <span class="n">root</span>
    <span class="n">IdentityFile</span>        <span class="o">~/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">keys</span><span class="o">/</span><span class="n">arc</span>
</pre></div>
</div>
<p>Also, you can generate your own keys (use your own home path):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ mkdir -p ~/.ssh/keys
$ ssh-keygen -t rsa -C &quot;arc@ebpf&quot;
Generating public/private rsa key pair.
<span class="hll">Enter file in which to save the key (/home/user/.ssh/id_rsa): /home/user/.ssh/keys/arc
</span>Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/user/.ssh/keys/arc
Your public key has been saved in /home/user/.ssh/keys/arc.pub
</pre></div>
</div>
<p>Add your public key to the overlay directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>-p<span class="w"> </span>buildroot/build/overlay/root/.ssh
cp<span class="w"> </span>-f<span class="w"> </span>~/.ssh/keys/arc.pub<span class="w"> </span>buildroot/build/overlay/root/.ssh/authorized_keys
</pre></div>
</div>
</section>
<section id="install-ssh-keys-for-host-s-authentication-host-keys">
<h3><a class="toc-backref" href="#id13">Install SSH Keys for Host’s Authentication (Host Keys)</a><a class="headerlink" href="#install-ssh-keys-for-host-s-authentication-host-keys" title="Permalink to this heading"></a></h3>
<p>By default, Linux with SSH daemon installed generates random host keys
if they don’t exist. For testing and debugging purposes using QEMU
it may lead to these difficulties:</p>
<ol class="arabic simple">
<li><p>Generating a set of host keys in QEMU may take a lot of time.</p></li>
<li><p>Each time you run QEMU with <code class="docutils literal notranslate"><span class="pre">vmlinux</span></code> image new keys a generated. Thus,
you have to clear cached host key for the QEMU instance to avoid complaining about
the changed target’s host key.</p></li>
</ol>
<p>Overlay already contains pregenerated host keys. However, you can generate
your own keys:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh-keygen<span class="w"> </span>-A<span class="w"> </span>-f<span class="w"> </span>buildroot/build/overlay
</pre></div>
</div>
</section>
</section>
<section id="building-images">
<h2><a class="toc-backref" href="#id14">Building Images</a><a class="headerlink" href="#building-images" title="Permalink to this heading"></a></h2>
<section id="building-rootfs-cpio">
<h3><a class="toc-backref" href="#id15">Building <code class="docutils literal notranslate"><span class="pre">rootfs.cpio</span></code></a><a class="headerlink" href="#building-rootfs-cpio" title="Permalink to this heading"></a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Buildroot requires Git of version 2+. Some old systems (e.g., CentOS 7) have
an outdated Git which is not supported by Buildroot’s build system. If you face
this problem then you have to find a way to install newer version of Git
(e.g., using third-party repositories).</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>SSHFS package requires <code class="docutils literal notranslate"><span class="pre">docutils</span></code> module for Python. Install it using
your package manager or using <code class="docutils literal notranslate"><span class="pre">pip</span></code> (<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">docutils</span></code>) or
delete the <code class="docutils literal notranslate"><span class="pre">BR2_PACKAGE_SSHFS=y</span></code> line if you aren’t going to use SSHFS.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Buildroot may complain about invalid headers’ version for the toolchain:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Incorrect selection of kernel headers: expected 5.16.x, got 5.18.x
</pre></div>
</div>
<p>E.g., <code class="docutils literal notranslate"><span class="pre">2022.09</span></code> release is shipped with headers for Linux kernel 5.16.x.
If it’s not your case then manually change headers’ versions for the toolchain
using <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">menuconfig</span></code>.</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>buildroot/build
make<span class="w"> </span>-C<span class="w"> </span>..<span class="w"> </span><span class="nv">O</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="w"> </span>defconfig<span class="w"> </span><span class="nv">BR2_DEFCONFIG</span><span class="o">=</span>build/qemu_hs4x_ebpf_defconfig
make<span class="w"> </span>-j<span class="w"> </span><span class="k">$(</span>nproc<span class="k">)</span>
</pre></div>
</div>
</section>
<section id="building-vmlinux">
<h3><a class="toc-backref" href="#id16">Building <code class="docutils literal notranslate"><span class="pre">vmlinux</span></code></a><a class="headerlink" href="#building-vmlinux" title="Permalink to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set necessary environment variables and build the kernel.</span>
<span class="nb">cd</span><span class="w"> </span>../../linux/build
<span class="nb">export</span><span class="w"> </span><span class="nv">ARCH</span><span class="o">=</span>arc
<span class="nb">export</span><span class="w"> </span><span class="nv">CROSS_COMPILE</span><span class="o">=</span>arc-linux-gnu-
<span class="nb">export</span><span class="w"> </span><span class="nv">C_INCLUDE_PATH</span><span class="o">=</span><span class="s2">&quot;/tools/elfutils/include&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LIBRARY_PATH</span><span class="o">=</span><span class="s2">&quot;/tools/elfutils/lib&quot;</span>
make<span class="w"> </span>-C<span class="w"> </span>..<span class="w"> </span><span class="nv">O</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="w"> </span>qemu_hs4x_ebpf_defconfig
make<span class="w"> </span>-j<span class="w"> </span><span class="k">$(</span>nproc<span class="k">)</span>
</pre></div>
</div>
</section>
</section>
<section id="workarounds-for-well-known-pitfalls">
<h2><a class="toc-backref" href="#id17">Workarounds for Well Known Pitfalls</a><a class="headerlink" href="#workarounds-for-well-known-pitfalls" title="Permalink to this heading"></a></h2>
<section id="errors-while-building-kernel-s-ebpf-files">
<h3><a class="toc-backref" href="#id18">Errors While Building Kernel’s eBPF Files</a><a class="headerlink" href="#errors-while-building-kernel-s-ebpf-files" title="Permalink to this heading"></a></h3>
<p>Change <code class="docutils literal notranslate"><span class="pre">kernel/bpf/Makefile</span></code> to prevent some build errors:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">diff --git a/kernel/bpf/Makefile b/kernel/bpf/Makefile</span>
<span class="gh">index ae90af5b0425..4699a022079a 100644</span>
<span class="gd">--- a/kernel/bpf/Makefile</span>
<span class="gi">+++ b/kernel/bpf/Makefile</span>
<span class="gu">@@ -4,7 +4,7 @@ ifneq ($(CONFIG_BPF_JIT_ALWAYS_ON),y)</span>
<span class="w"># ___bpf_prog_run() needs GCSE disabled on x86; see 3193c0836f203 for details</span>
<span class="w">cflags-nogcse-$(CONFIG_X86)$(CONFIG_CC_IS_GCC) := -fno-gcse</span>
<span class="w">endif</span>
<span class="gd">-CFLAGS_core.o += $(call cc-disable-warning, override-init) $(cflags-nogcse-yy) -Og -g3</span>
<span class="gi">+CFLAGS_core.o += $(call cc-disable-warning, override-init) $(cflags-nogcse-yy) -Og -g3 -finline-functions-called-once</span>
</pre></div>
</div>
</section>
<section id="workaround-for-complex-float-error">
<h3><a class="toc-backref" href="#id19">Workaround for <code class="docutils literal notranslate"><span class="pre">complex</span> <span class="pre">float</span></code> error</a><a class="headerlink" href="#workaround-for-complex-float-error" title="Permalink to this heading"></a></h3>
<p>Toolchains for ARC generate <code class="docutils literal notranslate"><span class="pre">complex</span> <span class="pre">float</span></code> DIE entries in <code class="docutils literal notranslate"><span class="pre">libgcc</span></code>.
At the moment such entries are not supported by <code class="docutils literal notranslate"><span class="pre">pahole</span></code>.
So, it’s necessary to disable generating BTF for floats. It’s already done in
<code class="docutils literal notranslate"><span class="pre">bpf-early-access</span></code> branch but if you want to build the Linux kernel from another
branch or repository with BTF information you can apply this patch
(<a class="reference external" href="https://github.com/foss-for-synopsys-dwc-arc-processors/linux/commit/b17d1955b67493afe37430694c8982411336fc4c">https://github.com/foss-for-synopsys-dwc-arc-processors/linux/commit/b17d1955b67493afe37430694c8982411336fc4c</a>):</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">diff --git a/scripts/pahole-flags.sh b/scripts/pahole-flags.sh</span>
<span class="gh">index 0d99ef17e4a5..23af14c6ef94 100755</span>
<span class="gd">--- a/scripts/pahole-flags.sh</span>
<span class="gi">+++ b/scripts/pahole-flags.sh</span>
<span class="gu">@@ -14,7 +14,7 @@ if [ &quot;${pahole_ver}&quot; -ge &quot;118&quot; ] &amp;&amp; [ &quot;${pahole_ver}&quot; -le &quot;121&quot; ]; then</span>
<span class="w"> </span>       extra_paholeopt=&quot;${extra_paholeopt} --skip_encoding_btf_vars&quot;
<span class="w">fi</span>
<span class="w">if [ &quot;${pahole_ver}&quot; -ge &quot;121&quot; ]; then</span>
<span class="gd">-       extra_paholeopt=&quot;${extra_paholeopt} --btf_gen_floats&quot;</span>
<span class="gi">+       extra_paholeopt=&quot;${extra_paholeopt}&quot;</span>
<span class="w">fi</span>
<span class="w">if [ &quot;${pahole_ver}&quot; -ge &quot;122&quot; ]; then</span>
<span class="w"> </span>       extra_paholeopt=&quot;${extra_paholeopt} -j&quot;
</pre></div>
</div>
</section>
</section>
<section id="running-linux-image-using-qemu">
<h2><a class="toc-backref" href="#id20">Running Linux Image Using QEMU</a><a class="headerlink" href="#running-linux-image-using-qemu" title="Permalink to this heading"></a></h2>
<p>All actions mentioned below are performed from the working directory
(root of <code class="docutils literal notranslate"><span class="pre">arc-bpf-testbench</span></code>).</p>
<section id="running-linux-using-user-level-network-interface">
<h3><a class="toc-backref" href="#id21">Running Linux Using User Level Network Interface</a><a class="headerlink" href="#running-linux-using-user-level-network-interface" title="Permalink to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make<span class="w"> </span>qemu-start
</pre></div>
</div>
</section>
<section id="running-linux-using-tun-tap-network-interface">
<h3><a class="toc-backref" href="#id22">Running Linux Using TUN/TAP Network Interface</a><a class="headerlink" href="#running-linux-using-tun-tap-network-interface" title="Permalink to this heading"></a></h3>
<p>TUN/TAP network interface allows interacting of the target with your host
in both directions. For example, you can mount host’s NFS directories inside
of the target. Configure TUN/TAP interface on host’s side:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Manually</span>
sudo<span class="w"> </span>ip<span class="w"> </span>tuntap<span class="w"> </span>add<span class="w"> </span>tap1<span class="w"> </span>mode<span class="w"> </span>tap
sudo<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.42.0.1/24<span class="w"> </span>dev<span class="w"> </span>tap1
sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>tap1<span class="w"> </span>up

<span class="c1"># ... or using testbench</span>
sudo<span class="w"> </span>make<span class="w"> </span>tap
</pre></div>
</div>
<p>Then run <code class="docutils literal notranslate"><span class="pre">vmlinux</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make<span class="w"> </span><span class="nv">USE_TAP</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>qemu-start
</pre></div>
</div>
<p>Configure a network interface on target’s side:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ifconfig<span class="w"> </span>eth0<span class="w"> </span><span class="m">10</span>.42.0.100
</pre></div>
</div>
</section>
<section id="configuring-linux">
<h3><a class="toc-backref" href="#id23">Configuring Linux</a><a class="headerlink" href="#configuring-linux" title="Permalink to this heading"></a></h3>
<p>Mount <code class="docutils literal notranslate"><span class="pre">debugfs</span></code> and turn JIT on:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># On host&#39;s side</span>
ssh<span class="w"> </span>arc<span class="w"> </span><span class="s2">&quot;mount -t debugfs debugfs /sys/kernel/debug&quot;</span>
ssh<span class="w"> </span>arc<span class="w"> </span><span class="s2">&quot;sysctl net.core.bpf_jit_enable=1&quot;</span>

<span class="c1"># ... or on target&#39;s side</span>
mount<span class="w"> </span>-t<span class="w"> </span>debugfs<span class="w"> </span>debugfs<span class="w"> </span>/sys/kernel/debug
sysctl<span class="w"> </span>net.core.bpf_jit_enable<span class="o">=</span><span class="m">1</span>

<span class="c1"># ... or using testbench for user level network interface</span>
make<span class="w"> </span>qemu-setup

<span class="c1"># ... or using testbench for tun/tap network interface</span>
make<span class="w"> </span><span class="nv">USE_TAP</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>qemu-setup
</pre></div>
</div>
</section>
<section id="running-kernel-s-basic-ebpf-tests">
<h3><a class="toc-backref" href="#id24">Running Kernel’s Basic eBPF Tests</a><a class="headerlink" href="#running-kernel-s-basic-ebpf-tests" title="Permalink to this heading"></a></h3>
<p>Send a module for testing to the target:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># For user level network interface</span>
rsync<span class="w"> </span>linux/build/lib/test_bpf.ko<span class="w"> </span>arc:/root

<span class="c1"># For TUN/TAP network interface</span>
rsync<span class="w"> </span>linux/build/lib/test_bpf.ko<span class="w"> </span>arc-tap:/root
</pre></div>
</div>
<p>Run the module on the target:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run all tests</span>
insmod<span class="w"> </span>test_bpf.ko

<span class="c1"># Run a specific</span>
insmod<span class="w"> </span>test_bpf.ko<span class="w"> </span><span class="nv">test_id</span><span class="o">=</span><span class="m">42</span>

<span class="c1"># Run a range of tests</span>
insmod<span class="w"> </span>test_bpf.ko<span class="w"> </span><span class="nv">test_range</span><span class="o">=</span><span class="m">42</span>,142
</pre></div>
</div>
</section>
</section>
<section id="building-and-running-ebpf-programs">
<h2><a class="toc-backref" href="#id25">Building and Running eBPF Programs</a><a class="headerlink" href="#building-and-running-ebpf-programs" title="Permalink to this heading"></a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Old operating systems like CentOS 7 and Ubuntu 18.04 contain
old versions of <code class="docutils literal notranslate"><span class="pre">clang</span></code> which may not be sufficient for building
modern eBPF programs. If building eBPF programs fails then try to
build the latest <code class="docutils literal notranslate"><span class="pre">clang</span></code> with eBPF target following
<a class="reference internal" href="clang.html#ebpf-clang"><span class="std std-ref">a corresponding guide</span></a> and put it into <code class="docutils literal notranslate"><span class="pre">PATH</span></code>.</p>
</div>
<p>Testbench contains a bunch of examples of eBPF programs. You
can build and load them using these commands from the root directory
of the testbench:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build dependencies</span>
make

<span class="c1"># Load programs for user level network interface</span>
make<span class="w"> </span>qemu-load

<span class="c1"># or for TUN/TAP network interface</span>
make<span class="w"> </span><span class="nv">USE_TAP</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>qemu-load
</pre></div>
</div>
<p>Run a program:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Manually on target&#39;s side</span>
./minimal

<span class="c1"># ... or using testbench on host&#39;s side</span>
make<span class="w"> </span>run-minimal
</pre></div>
</div>
<p>Explore <code class="docutils literal notranslate"><span class="pre">README.md</span></code> for <a class="reference external" href="https://github.com/foss-for-synopsys-dwc-arc-processors/arc-bpf-testbench">ARC eBPF Testbench</a>
or run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">help</span></code> for information about available commands.</p>
</section>
<section id="using-nfs-for-building-ebpf-programs-right-on-the-target">
<h2><a class="toc-backref" href="#id26">Using NFS for Building eBPF Programs Right on the Target</a><a class="headerlink" href="#using-nfs-for-building-ebpf-programs-right-on-the-target" title="Permalink to this heading"></a></h2>
<section id="configuring-nfs-in-centos-7-or-fedora">
<h3><a class="toc-backref" href="#id27">Configuring NFS in CentOS 7 or Fedora</a><a class="headerlink" href="#configuring-nfs-in-centos-7-or-fedora" title="Permalink to this heading"></a></h3>
<p>Install NFS to the host:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># For CentOS 7</span>
sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>nfs-utils

<span class="c1"># For Fedora</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>nfs-utils
</pre></div>
</div>
<p>Enable services and add rules for firewall:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>rpcbind<span class="w"> </span>nfs-server
sudo<span class="w"> </span>firewall-cmd<span class="w"> </span>--add-service<span class="o">=</span>nfs<span class="w"> </span>--permanent
sudo<span class="w"> </span>firewall-cmd<span class="w"> </span>--reload

<span class="c1"># Optional (only if you are going to use SSHFS instead of NFS)</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>sshd
sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>sshd
</pre></div>
</div>
</section>
<section id="configuring-nfs-in-ubuntu-18-04">
<h3><a class="toc-backref" href="#id28">Configuring NFS in Ubuntu 18.04</a><a class="headerlink" href="#configuring-nfs-in-ubuntu-18-04" title="Permalink to this heading"></a></h3>
<p>Install NFS to the host and enable it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>nfs-kernel-server
sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>nfs-server
</pre></div>
</div>
</section>
<section id="configuring-etc-exports">
<h3><a class="toc-backref" href="#id29">Configuring <code class="docutils literal notranslate"><span class="pre">/etc/exports</span></code></a><a class="headerlink" href="#configuring-etc-exports" title="Permalink to this heading"></a></h3>
<p>Add this line to <code class="docutils literal notranslate"><span class="pre">/etc/exports</span></code> (you can find <code class="docutils literal notranslate"><span class="pre">anonuid</span></code> and <code class="docutils literal notranslate"><span class="pre">anongid</span></code>
for your user using <code class="docutils literal notranslate"><span class="pre">id</span> <span class="pre">-u</span></code> and <code class="docutils literal notranslate"><span class="pre">id</span> <span class="pre">-g</span></code> respectively):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">nfs</span> <span class="o">*</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">all_squash</span><span class="p">,</span><span class="n">anonuid</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">anongid</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">no_subtree_check</span><span class="p">,</span><span class="n">insecure</span><span class="p">)</span>
</pre></div>
</div>
<p>Update the table of exported NFS file systems:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>exportfs<span class="w"> </span>-rv
</pre></div>
</div>
</section>
<section id="mounting-nfs-directory-inside-the-guest">
<h3><a class="toc-backref" href="#id30">Mounting NFS Directory Inside the Guest</a><a class="headerlink" href="#mounting-nfs-directory-inside-the-guest" title="Permalink to this heading"></a></h3>
<p>Create a directory for mounting NFS directory on target’s side:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>/nfs
</pre></div>
</div>
<p>If you use user level network interface for running QEMU then just run these
commands inside the guest:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using NFS</span>
mount<span class="w"> </span>-t<span class="w"> </span>nfs<span class="w"> </span><span class="m">10</span>.0.2.2:/nfs<span class="w"> </span>/nfs<span class="w"> </span>-o<span class="w"> </span>nolock

<span class="c1"># Using SSHFS</span>
sshfs<span class="w"> </span>-o<span class="w"> </span><span class="nv">idmap</span><span class="o">=</span>user,allow_other<span class="w"> </span>user@10.0.2.2:/nfs<span class="w"> </span>/nfs
</pre></div>
</div>
<p>If you prefer using TUN/TAP network interface, then run QEMU like <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">USE_TAP=1</span> <span class="pre">qemu-start</span></code>
and configure guest’s network interface as mentioned earlier. Then run this
line on target’s side:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using NFS</span>
mount<span class="w"> </span>-t<span class="w"> </span>nfs<span class="w"> </span><span class="m">10</span>.42.0.1:/nfs<span class="w"> </span>/nfs<span class="w"> </span>-o<span class="w"> </span>nolock

<span class="c1"># Using SSHFS</span>
sshfs<span class="w"> </span>-o<span class="w"> </span><span class="nv">idmap</span><span class="o">=</span>user,allow_other<span class="w"> </span>user@10.42.0.1:/nfs<span class="w"> </span>/nfs
</pre></div>
</div>
</section>
<section id="preparing-tools">
<h3><a class="toc-backref" href="#id31">Preparing Tools</a><a class="headerlink" href="#preparing-tools" title="Permalink to this heading"></a></h3>
<p><a class="reference internal" href="clang.html#ebpf-clang"><span class="std std-ref">Build Clang for ARC</span></a> and place a directory with <code class="docutils literal notranslate"><span class="pre">clang</span></code>
to <code class="docutils literal notranslate"><span class="pre">/nfs</span></code> (the full path to Clang root directory must be <code class="docutils literal notranslate"><span class="pre">/nfs/clang</span></code>).</p>
<p>Download, unpack and place a native glibc ARC HS
<a class="reference external" href="https://github.com/foss-for-synopsys-dwc-arc-processors/toolchain/releases">toolchain</a>
into <code class="docutils literal notranslate"><span class="pre">/nfs/arc-linux-gnu</span></code>.</p>
<p>Copy <code class="docutils literal notranslate"><span class="pre">/tools/arc-linux-gnu/sysroot</span></code> to <code class="docutils literal notranslate"><span class="pre">/nfs/sysroot</span></code>. Also build applications using testbench
(run <code class="docutils literal notranslate"><span class="pre">make</span></code> from the root directory of the testbench) and copy headers to the sysroot:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cp<span class="w"> </span>-r<span class="w"> </span>output/arc/deps/include/*<span class="w"> </span>/nfs/sysroot/usr/include/
</pre></div>
</div>
<p>Copy applications from the testbench:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cp<span class="w"> </span>-r<span class="w"> </span>apps<span class="w"> </span>/nfs
</pre></div>
</div>
</section>
<section id="building-ebpf-application">
<h3><a class="toc-backref" href="#id32">Building eBPF Application</a><a class="headerlink" href="#building-ebpf-application" title="Permalink to this heading"></a></h3>
<p>Use these commands inside the ARC guest (QEMU):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configure your PATH</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/nfs/clang/bin:</span><span class="nv">$PATH</span><span class="s2">&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/nfs/arc-linux-gnu/bin:</span><span class="nv">$PATH</span><span class="s2">&quot;</span>

<span class="c1"># Build &quot;minimal&quot;</span>
<span class="nb">cd</span><span class="w"> </span>/nfs/apps
clang<span class="w"> </span>-g<span class="w">                         </span><span class="se">\</span>
<span class="w">      </span>-O2<span class="w">                        </span><span class="se">\</span>
<span class="w">      </span>-target<span class="w"> </span>bpf<span class="w">                </span><span class="se">\</span>
<span class="w">      </span>-D__TARGET_ARCH_arc<span class="w">        </span><span class="se">\</span>
<span class="w">      </span>-I/nfs/sysroot/usr/include<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-c<span class="w"> </span>minimal.bpf.c<span class="w">           </span><span class="se">\</span>
<span class="w">      </span>-o<span class="w"> </span>minimal.bpf.o

bpftool<span class="w"> </span>gen<span class="w"> </span>skeleton<span class="w"> </span>minimal.bpf.o<span class="w"> </span>&gt;<span class="w"> </span>minimal.skel.h

gcc<span class="w"> </span>-I/nfs/sysroot/usr/include<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-L/usr/lib<span class="w"> </span>minimal.c<span class="w">       </span><span class="se">\</span>
<span class="w">    </span>-lbpf<span class="w">                      </span><span class="se">\</span>
<span class="w">    </span>-lelf<span class="w">                      </span><span class="se">\</span>
<span class="w">    </span>-lz<span class="w">                        </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>minimal

<span class="c1"># Prepare the Linux kernel</span>
mount<span class="w"> </span>-t<span class="w"> </span>debugfs<span class="w"> </span>debugfs<span class="w"> </span>/sys/kernel/debug
sysctl<span class="w"> </span>net.core.bpf_jit_enable<span class="o">=</span><span class="m">1</span>

<span class="c1"># Run the application</span>
./minimal
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="cross.html" class="btn btn-neutral float-left" title="Cross-compiling eBPF Programs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="clang.html" class="btn btn-neutral float-right" title="Building Clang with eBPF Target for ARC HS Hosts" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2022, Synopsys.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>